<!DOCTYPE html>
<meta charset="UTF-8"/>
<head>
    <title>Print Constructor</title>
</head>
<body>
<link rel="stylesheet" type="text/css"
      href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans|Arsenal|Bad+Script|Caveat|Comfortaa|Cormorant+Infant|Exo+2|Fira+Sans+Extra+Condensed|Forum|Kurale|Lobster|Marck+Script|Marmelad|Montserrat+Alternates|Old+Standard+TT|Oranienbaum|Oswald|PT+Sans+Narrow|Pacifico|Philosopher|Poiret+One|Prata|Roboto+Condensed|Ruslan+Display|Russo+One|Seymour+One|Underdog|Vollkorn|Yanone+Kaffeesatz&subset=latin,cyrillic"/>

<link rel="stylesheet" href="style.css" type="text/css">
<script src="../js/three.js" type="application/javascript"></script>
<script src="../js/OrbitControls.js" type="application/javascript"></script>
<script src="../js/fabric.js" type="application/javascript"></script>
<script src="../js/constructor.js" type="application/javascript"></script>
<script>
    let div = document.createElement("div");
    div.innerHTML = 'Constructor.version: <b>' + Constructor.version
        + '</b> fabric.version: <b>' + fabric.version + '</b>';
    div.style.fontFamily = 'Helvetica';
    document.body.appendChild(div);

    let pechatJson = '{"model":"cup_remastered","fills":[16777215,16777215,16777215],"sides":[{"objects":[{"fill":"rgba(142,69,139,1)","fontFamily":"Helvetica","fontSize":25,"fontStyle":"normal","fontWeight":"normal","height":28.25,"left":299.61,"lineHeight":1.16,"opacity":1,"scaleX":7.31,"scaleY":7.31,"text":"Те5к","textAlign":"left","top":117,"type":"i-text","width":54.02},{"filters":[],"left":282.96,"opacity":1,"scaleX":0.15,"scaleY":0.15,"src":"https://pechat.photo/image/cache//constructor/customer/guest/8518948acb50f82d0781f4f588375330/0f990f7d2c7ee3049b49b13dc314c720-2560x1891-default.jpg","top":154.72,"type":"image"},{"filters":[],"left":202.95,"opacity":1,"scaleX":0.51,"scaleY":0.51,"src":"https://pechat.photo/image/constructor/customer/guest/8518948acb50f82d0781f4f588375330/bc0d79a14517c2951b18e6d2c68225de.jpg","top":265.09,"type":"image"},{"filters":[],"left":168.65,"opacity":1,"scaleX":0.51,"scaleY":0.51,"src":"https://pechat.photo/image/constructor/customer/guest/8518948acb50f82d0781f4f588375330/bc0d79a14517c2951b18e6d2c68225de.jpg","top":212.63,"type":"image"},{"filters":[],"left":408.43,"opacity":1,"scaleX":0.45,"scaleY":0.45,"src":"https://pechat.photo/image/constructor/customer/guest/8518948acb50f82d0781f4f588375330/67a09df46aaa2f23e6ccf8f04f66f4ee.jpg","top":73.7,"type":"image"},{"filters":[],"left":205.77,"opacity":1,"scaleX":0.51,"scaleY":0.51,"src":"https://pechat.photo/image/constructor/customer/guest/8518948acb50f82d0781f4f588375330/bc0d79a14517c2951b18e6d2c68225de.jpg","top":156.94,"type":"image"},{"filters":[],"left":33.9,"opacity":1,"scaleX":0.45,"scaleY":0.45,"src":"https://pechat.photo/image/constructor/customer/guest/8518948acb50f82d0781f4f588375330/67a09df46aaa2f23e6ccf8f04f66f4ee.jpg","top":139.95,"type":"image"},{"filters":[],"left":464.95,"opacity":1,"scaleX":0.45,"scaleY":0.45,"src":"https://pechat.photo/image/constructor/customer/guest/8518948acb50f82d0781f4f588375330/67a09df46aaa2f23e6ccf8f04f66f4ee.jpg","top":298.68,"type":"image"}],"width":630,"height":285,"roundCorners":null}]}';

    let brokenImagesJson = '{"fills":[],"sides":[{"objects":[{"fill":"rgba(229,146,13,1)","fontFamily":"Helvetica","fontSize":25,"fontStyle":"normal","fontWeight":"normal","height":28.25,"left":357.22,"lineHeight":1.16,"opacity":1,"scaleX":7.07,"scaleY":7.07,"text":"Текст","textAlign":"left","top":158.7,"type":"i-text","width":67.87},{"fill":"rgba(62,91,226,1)","height":100,"left":202.51,"opacity":0.3,"scaleX":1.93,"scaleY":1.93,"top":345.72,"type":"triangle","width":100},{"fill":"rgba(17,127,116,1)","height":100,"left":335.18,"opacity":1,"radius":50,"scaleX":1,"scaleY":1,"top":296.46,"type":"circle","width":100},{"fill":"rgba(98,78,150,1)","height":100,"left":83.59,"opacity":1,"radius":50,"scaleX":1,"scaleY":1,"top":251.21,"type":"circle","width":100},{"fill":"rgba(139,93,141,1)","height":100,"left":401.47,"opacity":1,"scaleX":1,"scaleY":1,"top":442.98,"type":"triangle","width":100},{"fill":"rgba(22,104,171,1)","height":100,"left":547.58,"opacity":0.6,"scaleX":1.26,"scaleY":1.26,"top":379.37,"type":"rect","width":100},{"filters":[],"height":493,"left":514.89,"opacity":1,"scaleX":1,"scaleY":1,"src":"http://localhost:63342/render/examples/images/bug.png","top":147.07,"type":"image","width":500}],"width":750,"height":550}]}';
</script>

<table>
    <tr>
        <td>
            <div id="container"></div>
        </td>
        <td>
            <layers></layers>
        </td>
    </tr>
    <tr>
        <td>
            <div class="panel-title">General</div>
            <div class="panel">
                <button value="false" onclick="c.toggleMode();this.value=(c.getMode()===Mode.Mode3D);">3d</button>
                <button onclick="c.zoomIn()" value="zoom in">zoom +</button>
                <button onclick="c.zoomOut()" value="zoom out">zoom –</button>
                <button onclick="c.zoomToFit()" value="zoom to fit">zoom_to_actual_size</button>
                <button onclick="c.resetZoom()" value="zoom 1:1">search</button>
                <button onclick="c.setActiveSide(0)" value="side 1">1</button>
                <button onclick="c.setActiveSide(1)" value="side 2">2</button>
                <button onclick="c.setActiveSide(2)" value="side 3">3</button>
                <button onclick="c.setActiveSide(3)" value="side 4">4</button>
                <button onclick="c.getActiveSide().clear()">clear</button>
                <button onclick="c.addSide(800, 600)" value="addSide">add side</button>
                <button onclick="c.paste()" value="paste">clipboard</button>
                <button onclick="c.undo()" value="undo">⤺</button>
                <button onclick="c.redo()" value="redo">⤻</button>
                <button onclick="c.addElement(ElementType.RECTANGLE)" value="add rectangle">▢
                </button>
                <button onclick="c.addElement(ElementType.CIRCLE)" value="add circle">◯</button>
                <button onclick="c.addElement(ElementType.TRIANGLE)" value="add triangle">△
                </button>
                <button onclick="c.addElement(ElementType.TEXT)" value="add text">A</button>
                <button onclick="c.addImage('images/bug.png')" value="add image">png</button>
                <button onclick="c.addImage('images/duck.jpg')" value="add image 2">jpg</button>
                <button onclick="c.addImage('http://localhost:63342/render/examples/images/hunters.jpg')"
                        value="add image HTTP">
                    picture
                </button>

                <button onclick="c.setState(brokenImagesJson)">IMG1</button>
                <button onclick="c.setState(pechatJson)">IMG2</button>

                <button onclick="c.getSelection().toFront()">to front</button>
                <button onclick="c.getSelection().toBack()">to back</button>
                <button id="locked" type="button" value="false"
                        onclick="c.getSelection().setLocked(!c.getSelection().isLocked());this.value=c.getSelection().isLocked()">
                    lock
                </button>
                <button id="snap" value="false" onclick="c.snapToObjects=!c.snapToObjects;this.value=c.snapToObjects;"
                        value="snap to objects">snap
                </button>
                <button id="snapToGrid" value="false" onclick="c.snapToGrid=!c.snapToGrid;this.value=c.snapToGrid;"
                        value="snap to grid">data</button>

                <input type="button" onclick="document.getElementById('preview').src = c.preview.exportImage(256)"
                       value="preview"/>
                <input type="button" onclick="document.getElementById('preview').src = c.getActiveSide().exportImage(256, ImageType.JPG)"
                       value="preview side"/>
                <input type="button" onclick="imageRemote()" value="preview remote"/>
                <input type="button" onclick="exportAnimation()" value="banner"/>
                <input type="button" onclick="image()" value="image"/>

                <input type="button" onclick="loadFast()" value="loadFast"/>
                <button onclick="c.applyPreset('cup_remastered', [{width: 400, height: 300}]);">cup</button>
                <button onclick="c.applyPreset('coffee_cup', [{width: 400, height: 300}]);">cof</button>
                <button onclick="c.preview.loadModel('ball')">ball</button>
            </div>

            <div class="panel">
                <button onclick="c.getSelection().bringUp()">⬆︎</button>
                <button onclick="c.getSelection().bringDown()">⬇︎</button>

                <button onclick="c.getSelection().toLayer(0)">0</button>
                <button onclick="c.getSelection().toLayer(1)">1</button>
                <button onclick="c.getSelection().toLayer(2)">2</button>
                <button onclick="c.getSelection().toLayer(3)">3</button>
                <button onclick="c.getSelection().toLayer(4)">4</button>
            </div>
        </td>
    </tr>

    <tr>
        <td>
            <div id="selectionPanel" class="panel" style="display: none">
                <button onclick="c.copy()">copy</button>
                <button onclick="c.cut()">✄</button>
                <button onclick="c.duplicate()">clone</button>
                <button id="deleteBtn" onclick="c.remove()">╳</button>
                <input id="color" type="color" onchange="c.getSelection().setColor(this.value)"/>
                <input id="alpha" type="range" min="0.0" max="1.0" step="0.1"
                       oninput="c.getSelection().setAlpha(this.value)" />
                <input id="shadow" type="range" min="0.0" max="100.0" step="1.0"
                       oninput="c.getSelection().setShadow(this.value)"/>
            </div>
            <div id="panel3d" class="panel" style="display: none">
                <button onclick="c.preview.setFills('green', 0)">0</button>
                <button onclick="c.preview.setFills('green', 1)">1</button>
                <button onclick="c.preview.setFills('green', 2)">2</button>
                <button onclick="c.preview.setFills('green', 0, 1)">0, 1</button>
                <button onclick="c.preview.setFills('green', 0, 2)">0, 2</button>
                <button onclick="c.preview.setFills('green', 1, 2)">1, 2</button>
                <button onclick="c.preview.setFills('green', 0, 1, 2)">0, 1, 2</button>
                <button onclick="c.preview.clearFills()">clear fills</button>

            </div>
            <div id="imagePanel" class="panel" style="display: none">
                <button onclick="c.getSelection().addFilter(Filter.INVERT)">invert_selection</button>
                <button onclick="c.getSelection().addFilter(Filter.GRAYSCALE)">black_and_white</button>
                <button onclick="c.getSelection().addFilter(Filter.BRIGHTNESS)">sun</button>
                <button onclick="c.getSelection().addFilter(Filter.BLUR)">blur</button>
                <button onclick="c.getSelection().addFilter(Filter.SHARPEN)">starburst_shape</button>
                <button onclick="c.getSelection().addFilter(Filter.EMBOSS)">bubble</button>
                <button onclick="c.getSelection().resetFilters()">clear_filters</button>
            </div>
            <div id="textPanel" class="panel" style="display: none">
                <button onclick="c.getSelection().setBold(true)" value="bold">bold</button>
                <button onclick="c.getSelection().setItalic(true)" value="italic">italic</button>
                <button onclick="c.getSelection().setTextDecoration(TextDecoration.UNDERLINE)">underline</button>
                <input type="button" onclick="c.getSelection().setFontFamily('Times')" value="times"/>
                <input type="button" onclick="c.getSelection().setFontFamily('Lobster')" value="Lobster"/>
                <input type="button" onclick="c.getSelection().setFontFamily('Oranienbaum')" value="Oranienbaum"/>
                <input type="button" onclick="c.getSelection().setFontFamily('Seymour One')" value="Seymour"/>
            </div>
        </td>
    </tr>
</table>


<script>
    //Constructor.settings.localStorage.enabled = false;
    c = new Constructor(document.getElementById('container'));
    //c.setState('{"model":"mug1","sides":[{"width":600,"height":500}]}');
    preview = document.getElementById("preview");
</script>
<img src="" id="preview">
<script>
    selectionPanel = document.getElementById('selectionPanel');
    textPanel = document.getElementById('textPanel');
    imagePanel = document.getElementById('imagePanel');
    panel3d = document.getElementById('panel3d');

    function loadFast() {
        let s = new Date().getTime();
        c.setState('{"model":"ball","sides":[{"width":600,"height":500}]}', () => {
            console.log(new Date().getTime() - s, 'ms')
        });
    }

    color = document.getElementById("color");
    locked = document.getElementById("locked");
    alpha = document.getElementById("alpha");
    shadow = document.getElementById("shadow");
    c.onSelect(s => {
        color.value = s.getColor().toHex();
        locked.style.background = s.isLocked() ? "#bbbbbb" : null;
        alpha.value = c.getSelection().getAlpha();
        shadow.value = c.getSelection().getShadow();

        selectionPanel.style.display = null;

        if (c.getSelection().type === ElementType.TEXT) {
            textPanel.style.display = null;
        } else {
            textPanel.style.display = 'none';
        }

        if (c.getSelection().type === ElementType.IMAGE) {
            imagePanel.style.display = null;
        } else {
            imagePanel.style.display = 'none';
        }

    });
    c.onDeselect(s => {
        color.value = "#ffffff";
        locked.style.background = null;
        alpha.value = 0;
        shadow.value = 0;
        textPanel.style.display = 'none';
        selectionPanel.style.display = 'none';
        imagePanel.style.display = 'none';
    });
    c.onModeChange(() => {
        if (c.getMode() === Mode.Mode2D) {
            panel3d.style.display = 'none';
        } else {
            panel3d.style.display = null;
        }
    });
</script>

<script>
    function image() {
        c.preview.exportImage(src => {
            let image = new Image();
            image.src = src;
            let w = window.open("");
            w.document.write(image.outerHTML);
        }, 1024, ImageType.JPG)
    }

    function imageRemote() {
        let json = c.getState();
        var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance
        xmlhttp.open("POST", "http://pechat55.ru:2018/preview?width=256&height=256", true);
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                document.getElementById("preview").src = xmlhttp.responseText;
            } else {
                console.log(xmlhttp.responseText);
            }
        };
        xmlhttp.send(json);
    }

    function exportAnimation() {
        let s = new Date().getTime();
        c.preview.exportAnimation(src => {
            console.log(new Date().getTime() - s + ' ms ' + Math.round(src.length / 1024) + ' KB');
        }, 128);
    }

    document.addEventListener("keydown", keyDownTextField, false);

    function keyDownTextField(e) {
        var keyCode = e.keyCode;
        if (keyCode == 46) {
            document.getElementById("deleteBtn").click();
        }
    }
</script>
</body>
</html>
